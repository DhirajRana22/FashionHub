{% extends 'admin/base.html' %}

{% block title %}Order #{{ order.id }} - FashionHub Admin{% endblock %}
{% block page_title %}Order Details{% endblock %}

{% block content %}
<!-- Order Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            <h3 class="mb-0">Order #{{ order.id }}</h3>
            {% if order.status == 'pending' %}
                <span class="badge bg-warning ms-3">Pending</span>
            {% elif order.status == 'confirmed' %}
                <span class="badge bg-info ms-3">Confirmed</span>
            {% elif order.status == 'shipped' %}
                <span class="badge bg-primary ms-3">Shipped</span>
            {% elif order.status == 'delivered' %}
                <span class="badge bg-success ms-3">Delivered</span>
            {% elif order.status == 'cancelled' %}
                <span class="badge bg-danger ms-3">Cancelled</span>
            {% endif %}
        </div>
        <small class="text-muted">Placed on {{ order.created_at|date:"F d, Y \a\t H:i" }}</small>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
            <a href="{% url 'custom_admin:orders' %}" class="btn btn-admin btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Orders
            </a>
            <button type="button" class="btn btn-admin btn-outline-primary" onclick="printOrder()">
                <i class="fas fa-print me-2"></i>Print
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Order Information -->
    <div class="col-lg-8">
        <!-- Customer Information -->
        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-user me-2"></i>Customer Information
                </h5>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong>Name:</strong><br>
                        {{ order.user.get_full_name|default:order.user.username }}
                    </div>
                    <div class="mb-3">
                        <strong>Email:</strong><br>
                        <a href="mailto:{{ order.user.email }}">{{ order.user.email }}</a>
                    </div>
                    {% if order.user.userprofile.phone %}
                    <div class="mb-3">
                        <strong>Phone:</strong><br>
                        <a href="tel:{{ order.user.userprofile.phone }}">{{ order.user.userprofile.phone }}</a>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong>Customer Since:</strong><br>
                        {{ order.user.date_joined|date:"F Y" }}
                    </div>
                    <div class="mb-3">
                        <strong>Total Orders:</strong><br>
                        {{ order.user.order_set.count }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Shipping Address -->
        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-map-marker-alt me-2"></i>Shipping Address
                </h5>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong>Full Name:</strong><br>
                        {{ order.full_name }}
                    </div>
                    <div class="mb-3">
                        <strong>Email:</strong><br>
                        {{ order.email }}
                    </div>
                    <div class="mb-3">
                        <strong>Phone:</strong><br>
                        {{ order.phone }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong>Address:</strong><br>
                        {{ order.address }}
                    </div>
                    <div class="mb-3">
                        <strong>City:</strong><br>
                        {{ order.city }}
                    </div>
                    <div class="mb-3">
                        <strong>State:</strong><br>
                        {{ order.state }}
                    </div>
                    <div class="mb-3">
                        <strong>Postal Code:</strong><br>
                        {{ order.postal_code }}
                    </div>
                </div>
            </div>
            {% if order.receiver_name or order.receiver_phone %}
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6 class="text-muted mb-3">Receiver Information (if different)</h6>
                    {% if order.receiver_name %}
                    <div class="mb-2">
                        <strong>Receiver Name:</strong> {{ order.receiver_name }}
                    </div>
                    {% endif %}
                    {% if order.receiver_phone %}
                    <div class="mb-2">
                        <strong>Receiver Phone:</strong> {{ order.receiver_phone }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Order Items -->
        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-shopping-bag me-2"></i>Order Items ({{ order.orderitem_set.count }})
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.orderitem_set.all %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <strong>{{ item.product.name }}</strong><br>
                                        <small class="text-muted">{{ item.product.category.name }}</small>
                                        {% if item.product.season %}
                                            <br><small class="text-muted">{{ item.product.season.name }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>Rs.{{ item.price|floatformat:2 }}</td>
                            <td>{{ item.quantity }}</td>
                            <td><strong>Rs.{{ item.get_total|floatformat:2 }}</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3" class="text-end">Subtotal:</th>
                            <th>Rs.{{ order.get_subtotal|floatformat:2 }}</th>
                        </tr>
                        {% if order.shipping_cost %}
                        <tr>
                            <th colspan="3" class="text-end">Shipping:</th>
                            <th>Rs.{{ order.shipping_cost|floatformat:2 }}</th>
                        </tr>
                        {% endif %}
                        {% if order.tax_amount %}
                        <tr>
                            <th colspan="3" class="text-end">Tax:</th>
                            <th>Rs.{{ order.tax_amount|floatformat:2 }}</th>
                        </tr>
                        {% endif %}
                        <tr class="table-primary">
                            <th colspan="3" class="text-end">Total:</th>
                            <th>Rs.{{ order.total_amount|floatformat:2 }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Order Timeline -->
        <div class="admin-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-history me-2"></i>Order Timeline
                </h5>
            </div>
            <div class="timeline">
                {% for history in order.orderstatushistory_set.all %}
                <div class="timeline-item">
                    <div class="timeline-marker
                        {% if history.status == 'pending' %}bg-warning
                        {% elif history.status == 'confirmed' %}bg-info
                        {% elif history.status == 'shipped' %}bg-primary
                        {% elif history.status == 'delivered' %}bg-success
                        {% elif history.status == 'cancelled' %}bg-danger
                        {% endif %}"></div>
                    <div class="timeline-content">
                        <h6 class="mb-1">{{ history.get_status_display }}</h6>
                        <small class="text-muted">{{ history.created_at|date:"F d, Y \a\t H:i" }}</small>
                        {% if history.notes %}
                            <p class="mb-0 mt-1">{{ history.notes }}</p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-clock fa-2x mb-2"></i><br>
                    No status updates yet
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="d-grid gap-2">
                {% if order.status == 'pending' %}
                <button type="button" class="btn btn-admin btn-success" onclick="updateOrderStatus('confirmed')">
                    <i class="fas fa-check me-2"></i>Confirm Order
                </button>
                <button type="button" class="btn btn-admin btn-danger" onclick="updateOrderStatus('cancelled')">
                    <i class="fas fa-times me-2"></i>Cancel Order
                </button>
                {% elif order.status == 'confirmed' %}
                <button type="button" class="btn btn-admin btn-primary" onclick="updateOrderStatus('processing')">
                    <i class="fas fa-cog me-2"></i>Start Processing
                </button>
                <button type="button" class="btn btn-admin btn-danger" onclick="updateOrderStatus('cancelled')">
                    <i class="fas fa-times me-2"></i>Cancel Order
                </button>
                {% elif order.status == 'processing' %}
                <button type="button" class="btn btn-admin btn-warning" onclick="updateOrderStatus('packed')">
                    <i class="fas fa-box me-2"></i>Mark as Packed
                </button>
                <button type="button" class="btn btn-admin btn-danger" onclick="updateOrderStatus('cancelled')">
                    <i class="fas fa-times me-2"></i>Cancel Order
                </button>
                {% elif order.status == 'packed' %}
                <button type="button" class="btn btn-admin btn-info" onclick="updateOrderStatus('shipped')">
                    <i class="fas fa-shipping-fast me-2"></i>Mark as Shipped
                </button>
                <button type="button" class="btn btn-admin btn-danger" onclick="updateOrderStatus('cancelled')">
                    <i class="fas fa-times me-2"></i>Cancel Order
                </button>
                {% elif order.status == 'shipped' %}
                <button type="button" class="btn btn-admin btn-success" onclick="updateOrderStatus('delivered')">
                    <i class="fas fa-check-circle me-2"></i>Mark as Delivered
                </button>
                {% elif order.status == 'delivered' and order.payment_method == 'cash_on_delivery' and not order.payment_status %}
                <button type="button" class="btn btn-admin btn-warning" onclick="markPaymentReceived()">
                    <i class="fas fa-money-bill-wave me-2"></i>Payment Received
                </button>
                {% endif %}
                
                <hr>
                
                <button type="button" class="btn btn-admin btn-outline-primary" onclick="sendOrderEmail()">
                    <i class="fas fa-envelope me-2"></i>Send Order Email
                </button>
                <button type="button" class="btn btn-admin btn-outline-info" onclick="generateInvoice()">
                    <i class="fas fa-file-pdf me-2"></i>Generate Invoice
                </button>
                <button type="button" class="btn btn-admin btn-outline-success" onclick="exportOrderData()">
                    <i class="fas fa-download me-2"></i>Export Data
                </button>
                <button type="button" class="btn btn-admin btn-outline-secondary" onclick="printOrder()">
                    <i class="fas fa-print me-2"></i>Print Order
                </button>
            </div>
        </div>
        
        <!-- Payment Information -->
        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-credit-card me-2"></i>Payment Information
                </h5>
            </div>
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex justify-content-between">
                    <span>Payment Method:</span>
                    <strong>{{ order.payment_method|default:"Not specified" }}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>Payment Status:</span>
                    {% if order.payment_status %}
                        <span class="badge bg-success">Paid</span>
                    {% else %}
                        {% if order.payment_method == 'cash_on_delivery' %}
                            <span class="badge bg-warning">Pending (COD)</span>
                        {% else %}
                            <span class="badge bg-danger">Not Paid</span>
                        {% endif %}
                    {% endif %}
                </div>
                {% if order.transaction_id %}
                <div class="list-group-item d-flex justify-content-between">
                    <span>Transaction ID:</span>
                    <strong>{{ order.transaction_id }}</strong>
                </div>
                {% endif %}
                <div class="list-group-item d-flex justify-content-between">
                    <span>Amount:</span>
                    <strong>Rs.{{ order.total_amount|floatformat:2 }}</strong>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="admin-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-info-circle me-2"></i>Order Summary
                </h5>
            </div>
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex justify-content-between">
                    <span>Order ID:</span>
                    <strong>#{{ order.id }}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>Order Date:</span>
                    <strong>{{ order.created_at|date:"M d, Y" }}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>Items Count:</span>
                    <strong>{{ order.orderitem_set.count }}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>Total Quantity:</span>
                    <strong>{{ order.get_total_quantity }}</strong>
                </div>
                <div class="list-group-item d-flex justify-content-between">
                    <span>Order Value:</span>
                    <strong>Rs.{{ order.total_amount|floatformat:2 }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'custom_admin:order_detail' order.id %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <p>Update the status of order <strong>#{{ order.id }}</strong> to <strong id="newStatusText"></strong>?</p>
                    
                    <input type="hidden" name="status" id="statusInput">
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea name="notes" id="notes" class="form-control" rows="3" placeholder="Add any notes about this status change..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        The customer will be notified about this status change via email.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-2"></i>Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -22px;
    top: 20px;
    width: 2px;
    height: calc(100% + 10px);
    background-color: #dee2e6;
}

.timeline-marker {
    position: absolute;
    left: -26px;
    top: 4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

@media print {
    .btn, .modal, .sidebar {
        display: none !important;
    }
    
    .admin-card {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateOrderStatus(newStatus) {
    document.getElementById('newStatusText').textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
    document.getElementById('statusInput').value = newStatus;
    
    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
    modal.show();
}

function markPaymentReceived() {
    if (confirm('Mark payment as received for this COD order?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.href;
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const paymentReceived = document.createElement('input');
        paymentReceived.type = 'hidden';
        paymentReceived.name = 'payment_received';
        paymentReceived.value = 'true';
        
        form.appendChild(csrfToken);
        form.appendChild(paymentReceived);
        document.body.appendChild(form);
        form.submit();
    }
}

function printOrder() {
    window.print();
}

function sendOrderEmail() {
    if (confirm('Send order confirmation email to customer?')) {
        fetch(`/admin/orders/{{ order.id }}/send-email/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order email sent successfully!');
            } else {
                alert('Failed to send email: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error sending email: ' + error);
        });
    }
}

function generateInvoice() {
    // Open invoice in new window
    window.open(`/admin/orders/{{ order.id }}/invoice/`, '_blank');
}

function exportOrderData() {
    // Export order data as CSV
    window.location.href = `/admin/orders/{{ order.id }}/export/`;
}


</script>
{% endblock %}